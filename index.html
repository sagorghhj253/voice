<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VoiceTherapy AI - 10 Sentence Assessment</title>
    <style>
        /* ====== all previous styles remain exactly the same (condensed for brevity, but full) ====== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        body {
            background: #f0f3f8;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .login-container {
            background: #f0f3f8;
            border-radius: 32px;
            padding: 40px;
            width: 100%;
            max-width: 420px;
            box-shadow: 20px 20px 40px rgba(0, 0, 0, 0.08), -20px -20px 40px rgba(255, 255, 255, 0.7);
            display: block;
        }
        .login-container.hidden { display: none; }
        .login-header { text-align: center; margin-bottom: 30px; }
        .login-header h1 { color: #2d3e50; font-size: 32px; font-weight: 600; margin-bottom: 8px; }
        .login-header p { color: #6b7b8e; font-size: 15px; }
        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; margin-bottom: 8px; color: #4a5b6e; font-weight: 500; font-size: 14px; }
        .input-group input { width: 100%; padding: 16px 20px; border: none; background: #e8ecf5; border-radius: 50px; font-size: 16px; color: #2d3e50; box-shadow: inset 6px 6px 12px rgba(0, 0, 0, 0.05), inset -6px -6px 12px rgba(255, 255, 255, 0.8); transition: all 0.2s ease; }
        .input-group input:focus { outline: none; box-shadow: inset 8px 8px 16px rgba(0, 0, 0, 0.07), inset -8px -8px 16px rgba(255, 255, 255, 0.9); }
        .login-btn { width: 100%; padding: 16px; border: none; background: linear-gradient(145deg, #5a7af0, #4361e2); color: white; font-size: 16px; font-weight: 600; border-radius: 50px; cursor: pointer; box-shadow: 8px 8px 16px rgba(67, 97, 226, 0.2), -4px -4px 12px rgba(255, 255, 255, 0.8); transition: all 0.2s ease; margin-top: 10px; }
        .login-btn:hover { transform: translateY(-2px); box-shadow: 12px 12px 24px rgba(67, 97, 226, 0.3), -4px -4px 12px rgba(255, 255, 255, 0.9); }
        .demo-credentials { margin-top: 20px; padding: 16px; background: rgba(90, 122, 240, 0.08); border-radius: 20px; font-size: 14px; color: #4a5b6e; text-align: center; box-shadow: inset 2px 2px 5px rgba(0,0,0,0.02), inset -2px -2px 5px rgba(255,255,255,0.8); }
        .dashboard { width: 100%; max-width: 1400px; display: none; }
        .dashboard.active { display: block; }
        .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 24px; margin-bottom: 24px; }
        .card { background: #f0f3f8; border-radius: 28px; padding: 24px; box-shadow: 12px 12px 24px rgba(0, 0, 0, 0.05), -12px -12px 24px rgba(255, 255, 255, 0.8); transition: all 0.3s ease; border: 1px solid rgba(255, 255, 255, 0.3); }
        .card:hover { transform: translateY(-4px); box-shadow: 16px 16px 32px rgba(0, 0, 0, 0.08), -16px -16px 32px rgba(255, 255, 255, 0.9); }
        .large-card { grid-column: span 2; }
        .medium-card { grid-column: span 1; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; padding: 0 10px; }
        .welcome-text h2 { color: #2d3e50; font-size: 28px; font-weight: 600; margin-bottom: 5px; }
        .welcome-text p { color: #6b7b8e; font-size: 15px; }
        .user-profile { display: flex; align-items: center; gap: 25px; }
        .notification-badge { position: relative; font-size: 24px; color: #5a7af0; cursor: pointer; background: #f0f3f8; padding: 10px; border-radius: 50%; box-shadow: 5px 5px 10px rgba(0,0,0,0.05), -5px -5px 10px rgba(255,255,255,0.8); }
        .notification-dot { position: absolute; top: 5px; right: 5px; width: 10px; height: 10px; background: #ff6b6b; border-radius: 50%; border: 2px solid #f0f3f8; }
        .logout-btn { padding: 12px 28px; background: #e8ecf5; border: none; border-radius: 50px; color: #4a5b6e; font-weight: 600; font-size: 14px; cursor: pointer; box-shadow: 6px 6px 12px rgba(0, 0, 0, 0.05), -6px -6px 12px rgba(255, 255, 255, 0.8); transition: all 0.2s ease; }
        .logout-btn:hover { box-shadow: 8px 8px 16px rgba(0, 0, 0, 0.08), -8px -8px 16px rgba(255, 255, 255, 0.9); color: #5a7af0; }
        .ai-session { background: linear-gradient(145deg, #f5f9ff, #ebf0fe); }
        .ai-avatar { display: flex; align-items: center; gap: 15px; margin-bottom: 20px; }
        .ai-icon { font-size: 40px; background: #f0f3f8; padding: 10px; border-radius: 50%; box-shadow: 5px 5px 10px rgba(0,0,0,0.05), -5px -5px 10px rgba(255,255,255,0.8); }
        .ai-status { color: #5a7af0; font-size: 14px; font-weight: 500; background: rgba(90, 122, 240, 0.1); padding: 4px 12px; border-radius: 50px; display: inline-block; }
        .chat-messages { min-height: 130px; background: rgba(255, 255, 255, 0.5); border-radius: 22px; padding: 18px; margin-bottom: 20px; box-shadow: inset 4px 4px 10px rgba(0, 0, 0, 0.03), inset -4px -4px 10px rgba(255, 255, 255, 0.8); overflow-y: auto; max-height: 200px; }
        .message { margin-bottom: 12px; padding: 10px 16px; border-radius: 18px; max-width: 85%; }
        .message.ai { background: #f0f3f8; color: #2d3e50; align-self: flex-start; box-shadow: 4px 4px 8px rgba(0,0,0,0.03), -2px -2px 6px rgba(255,255,255,0.8); border-bottom-left-radius: 5px; }
        .message.user { background: #5a7af0; color: white; margin-left: auto; border-bottom-right-radius: 5px; box-shadow: 4px 4px 12px rgba(90, 122, 240, 0.2); }
        .voice-controls { display: flex; gap: 12px; margin-bottom: 12px; }
        .voice-btn { flex: 1; padding: 14px; border: none; background: #f0f3f8; border-radius: 50px; font-size: 15px; font-weight: 600; cursor: pointer; box-shadow: 6px 6px 12px rgba(0, 0, 0, 0.05), -4px -4px 8px rgba(255, 255, 255, 0.9); transition: all 0.2s ease; color: #4a5b6e; }
        .voice-btn.active { background: #5a7af0; color: white; box-shadow: 0 0 0 3px rgba(90, 122, 240, 0.2), 6px 6px 12px rgba(0,0,0,0.05); }
        .voice-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .voice-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 8px 8px 16px rgba(0, 0, 0, 0.08), -6px -6px 12px rgba(255, 255, 255, 0.9); }
        .sentence-controls { display: flex; gap: 12px; margin: 15px 0; }
        .sentence-btn { flex: 1; padding: 16px; border: none; border-radius: 50px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .repeat-btn { background: linear-gradient(145deg, #f0f3f8, #e8ecf5); color: #5a7af0; box-shadow: 6px 6px 12px rgba(0, 0, 0, 0.05), -4px -4px 8px rgba(255, 255, 255, 0.9); }
        .repeat-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 8px 8px 16px rgba(0, 0, 0, 0.08), -6px -6px 12px rgba(255, 255, 255, 0.9); color: #4361e2; }
        .next-btn { background: linear-gradient(145deg, #5a7af0, #4361e2); color: white; box-shadow: 8px 8px 16px rgba(67, 97, 226, 0.2), -4px -4px 12px rgba(255, 255, 255, 0.8); }
        .next-btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 12px 12px 24px rgba(67, 97, 226, 0.3), -4px -4px 12px rgba(255, 255, 255, 0.9); }
        .next-btn:disabled, .repeat-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .voice-selector { margin-top: 15px; padding: 15px; background: rgba(255, 255, 255, 0.5); border-radius: 20px; box-shadow: inset 3px 3px 8px rgba(0,0,0,0.02), inset -3px -3px 8px rgba(255,255,255,0.8); }
        .voice-selector label { display: block; color: #4a5b6e; font-size: 14px; font-weight: 500; margin-bottom: 8px; }
        .voice-selector select { width: 100%; padding: 12px 16px; border: none; background: #f0f3f8; border-radius: 50px; font-size: 14px; color: #2d3e50; box-shadow: 5px 5px 10px rgba(0,0,0,0.03), -5px -5px 10px rgba(255,255,255,0.8); cursor: pointer; outline: none; }
        .patient-info { margin-top: 15px; padding: 12px; background: rgba(255, 255, 255, 0.5); border-radius: 50px; text-align: center; color: #2d3e50; font-weight: 500; }
        .audio-stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin: 15px 0; }
        .stat-item { text-align: center; padding: 15px 10px; background: rgba(255, 255, 255, 0.5); border-radius: 20px; box-shadow: inset 3px 3px 8px rgba(0,0,0,0.02), inset -3px -3px 8px rgba(255,255,255,0.8); }
        .stat-label { font-size: 12px; color: #6b7b8e; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-value { font-size: 24px; font-weight: 700; color: #2d3e50; }
        .stat-unit { font-size: 12px; color: #8a9bb0; margin-left: 2px; }
        .waveform-container { height: 120px; margin: 20px 0; padding: 15px 10px; background: rgba(255, 255, 255, 0.3); border-radius: 20px; box-shadow: inset 3px 3px 8px rgba(0,0,0,0.02), inset -3px -3px 8px rgba(255,255,255,0.8); }
        .waveform-title { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; color: #4a5b6e; font-size: 13px; font-weight: 500; }
        .waveform-title span { color: #5a7af0; font-size: 12px; }
        .waveform-graph { display: flex; align-items: center; justify-content: space-between; gap: 2px; height: 70px; }
        .wave-bar { flex: 1; background: linear-gradient(to top, #5a7af0, #8aa4ff); border-radius: 3px 3px 0 0; transition: height 0.05s ease; min-height: 2px; max-height: 100%; box-shadow: 0 -2px 5px rgba(90, 122, 240, 0.2); }
        .spectrum-container { height: 100px; margin: 15px 0; padding: 10px 5px; background: rgba(255, 255, 255, 0.3); border-radius: 20px; box-shadow: inset 3px 3px 8px rgba(0,0,0,0.02); }
        .spectrum-graph { display: flex; align-items: flex-end; gap: 3px; height: 80px; }
        .freq-bar { flex: 1; background: linear-gradient(to top, #5a7af0, #8aa4ff); border-radius: 4px 4px 0 0; transition: height 0.1s ease; min-height: 2px; box-shadow: 0 -2px 5px rgba(90, 122, 240, 0.2); }
        .graph-container { height: 100px; margin-top: 15px; padding: 10px 5px; background: rgba(255, 255, 255, 0.3); border-radius: 20px; box-shadow: inset 3px 3px 8px rgba(0,0,0,0.02); }
        .graph-bars { display: flex; align-items: flex-end; gap: 4px; height: 100%; }
        .bar { flex: 1; background: linear-gradient(to top, #5a7af0, #8aa4ff); border-radius: 6px 6px 0 0; transition: height 0.2s ease; min-height: 2px; box-shadow: 0 -2px 5px rgba(90, 122, 240, 0.2); }
        .words-list { margin-top: 15px; max-height: 150px; overflow-y: auto; }
        .word-item { display: flex; justify-content: space-between; padding: 10px 15px; margin-bottom: 6px; background: rgba(255, 255, 255, 0.5); border-radius: 14px; font-size: 14px; box-shadow: inset 2px 2px 5px rgba(0,0,0,0.02); }
        .word-text { color: #2d3e50; font-weight: 500; }
        .word-accuracy { color: #5a7af0; font-weight: 600; }
        .word-accuracy.low { color: #ff8a8a; }
        .card-icon { font-size: 28px; color: #5a7af0; margin-bottom: 15px; background: rgba(255,255,255,0.5); width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; border-radius: 18px; box-shadow: 4px 4px 8px rgba(0,0,0,0.03), -4px -4px 8px rgba(255,255,255,0.8); }
        .card-title { color: #2d3e50; font-size: 18px; font-weight: 600; margin-bottom: 5px; }
        .card-subtitle { color: #8a9bb0; font-size: 14px; margin-bottom: 15px; }
        .progress-bar { width: 100%; height: 10px; background: #e0e5ed; border-radius: 10px; margin: 15px 0; overflow: hidden; box-shadow: inset 2px 2px 5px rgba(0,0,0,0.05); }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #5a7af0, #8aa4ff); border-radius: 10px; transition: width 0.3s ease; }
        .stat-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .stat-row:last-child { border-bottom: none; }
        .stat-label-small { color: #6b7b8e; font-size: 14px; }
        .stat-value-small { color: #2d3e50; font-weight: 600; font-size: 16px; }
        .sentence-preview { margin-top: 15px; padding: 20px; background: rgba(255, 255, 255, 0.5); border-radius: 20px; text-align: center; font-size: 20px; font-weight: 500; color: #2d3e50; box-shadow: inset 3px 3px 8px rgba(0,0,0,0.02), inset -3px -3px 8px rgba(255,255,255,0.8); }
        .word-tags { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 15px; }
        .word-tag { padding: 6px 14px; background: #e8ecf5; border-radius: 50px; font-size: 13px; color: #4a5b6e; box-shadow: 3px 3px 6px rgba(0,0,0,0.03), -2px -2px 4px rgba(255,255,255,0.8); }
        .level-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .level-name { color: #4a5b6e; font-weight: 500; }
        .level-progress { color: #5a7af0; font-weight: 600; }
        .voice-settings { display: flex; gap: 10px; margin-top: 10px; flex-wrap: wrap; }
        .voice-speed { flex: 1; padding: 10px; background: #f0f3f8; border-radius: 50px; display: flex; align-items: center; gap: 10px; box-shadow: inset 3px 3px 6px rgba(0,0,0,0.03), inset -3px -3px 6px rgba(255,255,255,0.8); }
        .voice-speed input { flex: 1; height: 4px; -webkit-appearance: none; background: linear-gradient(90deg, #5a7af0, #8aa4ff); border-radius: 2px; outline: none; }
        .voice-speed input::-webkit-slider-thumb { -webkit-appearance: none; width: 16px; height: 16px; background: white; border-radius: 50%; box-shadow: 0 2px 6px rgba(90,122,240,0.3); cursor: pointer; border: 2px solid #5a7af0; }
        .voice-speed span { color: #4a5b6e; font-size: 12px; min-width: 35px; }
        .custom-text-section { margin: 20px 0 10px 0; padding: 18px; background: rgba(255, 255, 255, 0.6); border-radius: 28px; box-shadow: inset 4px 4px 10px rgba(0,0,0,0.02), inset -4px -4px 10px rgba(255,255,255,0.8); }
        .custom-text-title { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; color: #2d3e50; font-weight: 600; font-size: 16px; }
        .custom-text-title span { font-size: 24px; }
        .custom-input-area { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
        .custom-input-area input { flex: 3; min-width: 200px; padding: 16px 20px; border: none; background: #e8ecf5; border-radius: 50px; font-size: 16px; color: #2d3e50; box-shadow: inset 6px 6px 12px rgba(0, 0, 0, 0.05), inset -6px -6px 12px rgba(255, 255, 255, 0.8); }
        .custom-input-area input:focus { outline: none; box-shadow: inset 8px 8px 16px rgba(0, 0, 0, 0.07), inset -8px -8px 16px rgba(255, 255, 255, 0.9); }
        .speak-custom-btn { flex: 1; padding: 16px 20px; border: none; background: linear-gradient(145deg, #5a7af0, #4361e2); color: white; font-weight: 600; border-radius: 50px; cursor: pointer; box-shadow: 8px 8px 16px rgba(67, 97, 226, 0.2), -4px -4px 12px rgba(255, 255, 255, 0.8); transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; gap: 6px; white-space: nowrap; }
        .speak-custom-btn:hover { transform: translateY(-2px); box-shadow: 12px 12px 24px rgba(67, 97, 226, 0.3), -4px -4px 12px rgba(255, 255, 255, 0.9); }
        /* NEW: progress and results */
        .test-progress { margin: 15px 0; font-weight: 600; color: #2d3e50; display: flex; justify-content: space-between; }
        .feature-comparison { margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.4); border-radius: 24px; }
        .comp-row { display: flex; justify-content: space-around; margin: 10px 0; font-size: 13px; }
        .comp-bar-container { height: 100px; display: flex; align-items: flex-end; justify-content: center; gap: 30px; margin: 10px 0; }
        .comp-bar-group { text-align: center; width: 60px; }
        .comp-bar-label { font-size: 11px; color: #6b7b8e; }
        .comp-bar { width: 30px; background: linear-gradient(to top, #5a7af0, #8aa4ff); border-radius: 6px 6px 0 0; margin: 0 auto; height: 0px; transition: height 0.3s; }
        .ai-bar { background: #ff8a5c; }
        .final-score { font-size: 24px; font-weight: 700; color: #2d3e50; text-align: center; margin: 20px 0; }
        @media (max-width: 1200px) { .grid { grid-template-columns: repeat(2, 1fr); } .large-card { grid-column: span 2; } }
        @media (max-width: 768px) { .grid { grid-template-columns: 1fr; } .large-card { grid-column: span 1; } .header { flex-direction: column; gap: 15px; text-align: center; } }
    </style>
</head>
<body>
    <!-- Login Container -->
    <div class="login-container" id="loginContainer">
        <div class="login-header">
            <h1>üé§ VoiceTherapy AI</h1>
            <p>10-sentence assessment</p>
        </div>
        <form id="loginForm" onsubmit="return false;">
            <div class="input-group">
                <label>User ID</label>
                <input type="text" id="username" placeholder="Enter your user ID" value="dipu">
            </div>
            <div class="input-group">
                <label>Password</label>
                <input type="password" id="password" placeholder="Enter your password" value="1234">
            </div>
            <button type="button" class="login-btn" id="loginButton">Start Session ‚Üí</button>
        </form>
        <div class="demo-credentials">
            <strong>Demo Credentials</strong><br>
            User ID: dipu | Password: 1234
        </div>
    </div>

    <!-- Main Dashboard -->
    <div class="dashboard" id="dashboard">
        <!-- Header -->
        <div class="header">
            <div class="welcome-text">
                <h2>Welcome, <span id="patientName">dipu</span>! üëã</h2>
                <p>Complete the 10 diagnostic sentences</p>
            </div>
            <div class="user-profile">
                <div class="notification-badge"><span>üîî</span><span class="notification-dot"></span></div>
                <button class="logout-btn" id="logoutBtn">Logout</button>
            </div>
        </div>

        <!-- Main Grid -->
        <div class="grid">
            <!-- Large Feature Card - AI Session -->
            <div class="card large-card ai-session">
                <div class="ai-avatar">
                    <span class="ai-icon">üó£Ô∏è</span>
                    <div>
                        <div class="card-title">10-Sentence Diagnostic</div>
                        <span class="ai-status" id="sessionStatus">‚óè Ready</span>
                    </div>
                </div>
                
                <!-- Chat Area -->
                <div class="chat-messages" id="chatMessages">
                    <div class="message ai">Hello! I'll guide you through 10 specific sentences. Please repeat each one after me.</div>
                </div>

                <!-- Voice Controls -->
                <div class="voice-controls">
                    <button class="voice-btn" id="startSessionBtn">‚ñ∂ Start Assessment</button>
                    <button class="voice-btn" id="recordBtn" disabled>üé§ Record</button>
                    <button class="voice-btn" id="stopBtn" disabled>‚èπ Stop</button>
                </div>
                
                <!-- Sentence Control Buttons - Repeat and Next -->
                <div class="sentence-controls">
                    <button class="sentence-btn repeat-btn" id="repeatBtn" disabled><span>üîÑ</span> Repeat</button>
                    <button class="sentence-btn next-btn" id="nextSentenceBtn" disabled>Next ‚Üí</button>
                </div>
                
                <!-- Voice Selector (optional) -->
                <div class="voice-selector">
                    <label>üéµ AI Voice</label>
                    <select id="voiceSelect"><option>Loading voices...</option></select>
                    <div class="voice-settings">
                        <div class="voice-speed">
                            <span>üê¢</span>
                            <input type="range" id="voiceSpeed" min="0.5" max="2" step="0.1" value="1">
                            <span>üêá</span>
                        </div>
                        <div style="font-size:12px; color:#5a7af0;" id="speedValue">Speed: 1.0x</div>
                    </div>
                </div>
                
                <!-- Patient Info -->
                <div class="patient-info" id="patientInfo" style="display: none;">
                    <span id="patientNameDisplay"></span> ‚Ä¢ <span id="patientAgeDisplay"></span> years
                </div>

                <!-- TEST PROGRESS INDICATOR -->
                <div class="test-progress">
                    <span>Sentence <span id="currentTestNum">0</span>/10</span>
                    <span>Avg accuracy: <span id="runningAvg">0</span>%</span>
                </div>
            </div>

            <!-- Medium Card - Audio Analysis + Comparison -->
            <div class="card medium-card">
                <div class="card-icon">üìä</div>
                <div class="card-title">Feature Comparison</div>
                <div class="card-subtitle">AI (orange) vs Your voice (blue)</div>
                
                <!-- Comparison bar graph for RMS, ZCR, Centroid -->
                <div class="feature-comparison">
                    <div class="comp-row"><span>RMS Energy</span><span id="rmsCompare">0 / 0</span></div>
                    <div class="comp-bar-container">
                        <div class="comp-bar-group"><div class="comp-bar" id="rmsBarAi" style="height:0px"></div><div class="comp-bar-label">AI</div></div>
                        <div class="comp-bar-group"><div class="comp-bar ai-bar" id="rmsBarUser" style="height:0px"></div><div class="comp-bar-label">You</div></div>
                    </div>
                    <div class="comp-row"><span>Zero-crossing</span><span id="zcrCompare">0 / 0</span></div>
                    <div class="comp-bar-container">
                        <div class="comp-bar-group"><div class="comp-bar" id="zcrBarAi" style="height:0px"></div><div class="comp-bar-label">AI</div></div>
                        <div class="comp-bar-group"><div class="comp-bar ai-bar" id="zcrBarUser" style="height:0px"></div><div class="comp-bar-label">You</div></div>
                    </div>
                    <div class="comp-row"><span>Spectral Centroid</span><span id="centroidCompare">0 / 0</span></div>
                    <div class="comp-bar-container">
                        <div class="comp-bar-group"><div class="comp-bar" id="centBarAi" style="height:0px"></div><div class="comp-bar-label">AI</div></div>
                        <div class="comp-bar-group"><div class="comp-bar ai-bar" id="centBarUser" style="height:0px"></div><div class="comp-bar-label">You</div></div>
                    </div>
                </div>

                <!-- live stats also shown -->
                <div class="audio-stats">
                    <div class="stat-item"><div class="stat-label">RMS (live)</div><span class="stat-value" id="rmsValue">0.0</span><span class="stat-unit">dB</span></div>
                    <div class="stat-item"><div class="stat-label">ZCR (live)</div><span class="stat-value" id="zcrValue">0</span><span class="stat-unit">Hz</span></div>
                    <div class="stat-item"><div class="stat-label">Centroid (live)</div><span class="stat-value" id="centroidValue">0</span><span class="stat-unit">Hz</span></div>
                    <div class="stat-item"><div class="stat-label">Accuracy</div><span class="stat-value" id="accuracyValue">0</span><span class="stat-unit">%</span></div>
                </div>
                <!-- Waveform (legacy) -->
                <div class="waveform-container"><div class="waveform-title"><span>üéµ Waveform</span><span id="waveformStatus">Waiting</span></div><div class="waveform-graph" id="waveformGraph"></div></div>
            </div>
        </div>

        <!-- Second Row: Words accuracy & final score card -->
        <div class="grid">
            <div class="card">
                <div class="card-icon">üìù</div>
                <div class="card-title">Word Accuracy</div>
                <div class="words-list" id="problematicWords"><div class="word-item"><span class="word-text">Ready</span><span class="word-accuracy">--</span></div></div>
                <div class="progress-bar"><div class="progress-fill" style="width:0%" id="overallProgress"></div></div>
                <div style="display:flex; justify-content:space-between;"><span>Overall</span><span><span id="overallAccuracy">0</span>%</span></div>
            </div>
            <div class="card">
                <div class="card-icon">üèÅ</div>
                <div class="card-title">Final Results</div>
                <div class="final-score" id="finalAverage">‚Äî</div>
                <div style="text-align:center;">after 10 sentences</div>
                <div style="margin-top:15px;" id="sessionCompletedMsg"></div>
            </div>
            <div class="card">
                <div class="card-icon">üìã</div>
                <div class="card-title">Sentences List</div>
                <div style="max-height:200px; overflow-y:auto;" id="sentenceChecklist"></div>
            </div>
            <div class="card">
                <div class="card-icon">‚ö°</div>
                <div class="card-title">Session Stats</div>
                <div class="stat-row"><span class="stat-label-small">Completed</span><span class="stat-value-small" id="sentencesCompleted">0</span></div>
                <div class="stat-row"><span class="stat-label-small">Session time</span><span class="stat-value-small" id="sessionTime">00:00</span></div>
                <div class="stat-row"><span class="stat-label-small">Avg accuracy</span><span class="stat-value-small" id="avgAccDisplay">0</span></div>
            </div>
        </div>
    </div>

    <script>
        (function() {
            // ---------- Configuration ----------
            const fixedSentences = [
                { text: "The quick brown fox jumps over the lazy dog", focus: "ALLITERATION" },
                { text: "She sells seashells by the seashore", focus: "TONGUE TWISTER" },
                { text: "Peter Piper picked a peck of pickled peppers", focus: "ARTICULATION" },
                { text: "How much wood would a woodchuck chuck", focus: "FLUENCY" },
                { text: "I saw Susie sitting in a shoeshine shop", focus: "CONSONANTS" },
                { text: "Fuzzy Wuzzy was a bear", focus: "VOWELS" },
                { text: "Around the rugged rocks the ragged rascal ran", focus: "RHYTHM" },
                { text: "Six slippery snails slid slowly seaward", focus: "S-BLENDS" },
                { text: "Three free throws", focus: "TH SOUNDS" },
                { text: "Red lorry, yellow lorry", focus: "L/R SOUNDS" }
            ];

            // State
            let isLoggedIn = false;
            let isSessionActive = false;
            let isRecording = false;
            let patientInfo = { name: '', age: '' };
            let currentSentenceIndex = 0;          // 0..9
            let currentSentenceObj = null;
            let aiFeatures = { rms: 0, zcr: 0, centroid: 0 };  // stored from AI playback
            let userFeatures = { rms: 0, zcr: 0, centroid: 0 };
            let results = [];                        // store per sentence { accuracy, rmsDiff etc }
            let totalAccuracySum = 0;
            let audioContext = null;
            let analyser = null;
            let mediaStream = null;
            let animationFrame = null;
            let recognition = null;
            let synthesis = window.speechSynthesis;
            let sessionTimer = null;
            let seconds = 0;
            let availableVoices = [];
            let selectedVoice = null;
            let voiceSpeed = 1.0;
            let isCapturingForUser = false;          // flag to indicate we should capture user features

            // DOM elements
            const loginContainer = document.getElementById('loginContainer');
            const dashboard = document.getElementById('dashboard');
            const loginButton = document.getElementById('loginButton');
            const logoutBtn = document.getElementById('logoutBtn');
            const startSessionBtn = document.getElementById('startSessionBtn');
            const recordBtn = document.getElementById('recordBtn');
            const stopBtn = document.getElementById('stopBtn');
            const repeatBtn = document.getElementById('repeatBtn');
            const nextSentenceBtn = document.getElementById('nextSentenceBtn');
            const chatMessages = document.getElementById('chatMessages');
            const patientInfoDiv = document.getElementById('patientInfo');
            const patientNameDisplay = document.getElementById('patientNameDisplay');
            const patientAgeDisplay = document.getElementById('patientAgeDisplay');
            const patientNameSpan = document.getElementById('patientName');
            const voiceSelect = document.getElementById('voiceSelect');
            const voiceSpeedInput = document.getElementById('voiceSpeed');
            const speedValue = document.getElementById('speedValue');
            const waveformGraph = document.getElementById('waveformGraph');
            const spectrumGraph = document.getElementById('spectrumGraph'); // not heavily used
            const waveformStatus = document.getElementById('waveformStatus');
            const rmsValue = document.getElementById('rmsValue');
            const zcrValue = document.getElementById('zcrValue');
            const centroidValue = document.getElementById('centroidValue');
            const accuracyValue = document.getElementById('accuracyValue');
            const overallAccuracy = document.getElementById('overallAccuracy');
            const overallProgress = document.getElementById('overallProgress');
            const problematicWords = document.getElementById('problematicWords');
            const sentencesCompletedSpan = document.getElementById('sentencesCompleted');
            const sessionTimeSpan = document.getElementById('sessionTime');
            const currentTestNum = document.getElementById('currentTestNum');
            const runningAvg = document.getElementById('runningAvg');
            const finalAverage = document.getElementById('finalAverage');
            const sentenceChecklist = document.getElementById('sentenceChecklist');
            const avgAccDisplay = document.getElementById('avgAccDisplay');
            // comparison bars
            const rmsBarAi = document.getElementById('rmsBarAi');
            const rmsBarUser = document.getElementById('rmsBarUser');
            const zcrBarAi = document.getElementById('zcrBarAi');
            const zcrBarUser = document.getElementById('zcrBarUser');
            const centBarAi = document.getElementById('centBarAi');
            const centBarUser = document.getElementById('centBarUser');
            const rmsCompare = document.getElementById('rmsCompare');
            const zcrCompare = document.getElementById('zcrCompare');
            const centroidCompare = document.getElementById('centroidCompare');

            // Helper functions
            function initGraphs() {
                if (!waveformGraph) return;
                waveformGraph.innerHTML = '';
                for (let i=0;i<30;i++) { let d=document.createElement('div'); d.className='wave-bar'; d.style.height='2px'; waveformGraph.appendChild(d); }
            }

            function loadVoices() {
                availableVoices = synthesis.getVoices();
                voiceSelect.innerHTML = '';
                const englishVoices = availableVoices.filter(v => v.lang.includes('en'));
                if (englishVoices.length) {
                    englishVoices.forEach(v => { let opt = document.createElement('option'); opt.value = v.name; opt.textContent = `${v.name} (${v.lang})`; voiceSelect.appendChild(opt); });
                    selectedVoice = englishVoices[0];
                    voiceSelect.value = selectedVoice.name;
                } else voiceSelect.innerHTML = '<option>No English voices</option>';
            }

            // Speak & capture AI features (simulated by analyzing a short dummy buffer)
            function speakAndCaptureAI(text) {
                if (synthesis.speaking) synthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                if (selectedVoice) utterance.voice = selectedVoice;
                utterance.rate = voiceSpeed;
                utterance.pitch = 1;
                // Simulate AI feature extraction (in real scenario you would analyze playback; here we assign reasonable random-ish values based on text length)
                let baseRMS = 40 + (text.length % 20);
                let baseZCR = 80 + (text.split(' ').length * 5);
                let baseCentroid = 120 + (text.length * 2);
                aiFeatures = { rms: baseRMS, zcr: baseZCR, centroid: baseCentroid };
                // Update comparison display (prep for user capture)
                updateComparisonBars(null); // show only AI bars for now
                synthesis.speak(utterance);
                addAIMessage(`üîä AI speaks: "${text}"`);
            }

            // Capture user features from live analyser (call during recording)
            function captureUserFeatures() {
                if (!analyser || !isRecording) return { rms:0, zcr:0, centroid:0 };
                const dataArray = new Uint8Array(analyser.frequencyBinCount);
                const timeData = new Uint8Array(analyser.frequencyBinCount);
                analyser.getByteFrequencyData(dataArray);
                analyser.getByteTimeDomainData(timeData);
                // RMS
                let sumSq = 0; for (let i=0;i<dataArray.length;i++) sumSq += dataArray[i]*dataArray[i];
                let rms = Math.sqrt(sumSq/dataArray.length);
                // Zero-crossing
                let zc = 0; for (let i=1;i<timeData.length;i++) if ((timeData[i-1]<128 && timeData[i]>=128)||(timeData[i-1]>=128 && timeData[i]<128)) zc++;
                let zcrVal = Math.round(zc * (audioContext ? audioContext.sampleRate/1000 : 1) / timeData.length);
                // Centroid
                let weighted=0, sum=0; for (let i=0;i<dataArray.length;i++) { weighted += i*dataArray[i]; sum+=dataArray[i]; }
                let centroid = sum>0 ? weighted/sum : 0;
                return { rms: rms/2.55, zcr: zcrVal, centroid: Math.round(centroid*10) };
            }

            // Update comparison bars and text
            function updateComparisonBars(userFeat) {
                if (!userFeat) userFeat = { rms:0, zcr:0, centroid:0 };
                // scale for display (max expected ~100)
                let maxRms = 100, maxZcr=500, maxCent=1000;
                rmsBarAi.style.height = Math.min(80, (aiFeatures.rms / maxRms)*80) + 'px';
                rmsBarUser.style.height = Math.min(80, (userFeat.rms / maxRms)*80) + 'px';
                zcrBarAi.style.height = Math.min(80, (aiFeatures.zcr / maxZcr)*80) + 'px';
                zcrBarUser.style.height = Math.min(80, (userFeat.zcr / maxZcr)*80) + 'px';
                centBarAi.style.height = Math.min(80, (aiFeatures.centroid / maxCent)*80) + 'px';
                centBarUser.style.height = Math.min(80, (userFeat.centroid / maxCent)*80) + 'px';
                rmsCompare.innerText = `${aiFeatures.rms.toFixed(1)} / ${userFeat.rms.toFixed(1)}`;
                zcrCompare.innerText = `${aiFeatures.zcr} / ${userFeat.zcr}`;
                centroidCompare.innerText = `${aiFeatures.centroid} / ${userFeat.centroid}`;
            }

            // Compute accuracy based on feature differences
            function computeAccuracy(ai, user) {
                let rmsDiff = Math.abs(ai.rms - user.rms) / Math.max(ai.rms,1);
                let zcrDiff = Math.abs(ai.zcr - user.zcr) / Math.max(ai.zcr,1);
                let centDiff = Math.abs(ai.centroid - user.centroid) / Math.max(ai.centroid,1);
                let avgDiff = (rmsDiff + zcrDiff + centDiff)/3;
                let acc = Math.max(0, 100 - avgDiff*100);
                return Math.min(100, Math.round(acc));
            }

            // Store result and move on
            function finishCurrentSentence() {
                if (!currentSentenceObj) return;
                let userFeat = userFeatures;
                let acc = computeAccuracy(aiFeatures, userFeat);
                results[currentSentenceIndex] = { sentence: currentSentenceObj.text, accuracy: acc, ai: {...aiFeatures}, user: {...userFeat} };
                totalAccuracySum += acc;
                // Update displays
                let completed = results.filter(r=>r!==undefined).length;
                sentencesCompletedSpan.innerText = completed;
                overallAccuracy.innerText = Math.round(totalAccuracySum / Math.max(1,completed));
                overallProgress.style.width = (totalAccuracySum / Math.max(1,completed)) + '%';
                runningAvg.innerText = Math.round(totalAccuracySum / Math.max(1,completed));
                avgAccDisplay.innerText = Math.round(totalAccuracySum / Math.max(1,completed));
                accuracyValue.innerText = acc;
                // Add checklist
                updateChecklist();

                if (currentSentenceIndex === 9) { // last sentence done
                    let finalAvg = totalAccuracySum / 10;
                    finalAverage.innerText = finalAvg.toFixed(1) + '%';
                    addAIMessage(`üéâ Assessment complete! Your final average accuracy: ${finalAvg.toFixed(1)}%`);
                    endSession();
                } else {
                    // enable next sentence
                    nextSentenceBtn.disabled = false;
                }
                // reset user features capture flag
                isCapturingForUser = false;
            }

            function updateChecklist() {
                let html = '';
                fixedSentences.forEach((s,idx) => {
                    let status = results[idx] ? `‚úÖ ${results[idx].accuracy}%` : '‚è≥ pending';
                    html += `<div style="font-size:12px; margin:4px 0;">${idx+1}. ${s.focus} ‚Äî ${status}</div>`;
                });
                sentenceChecklist.innerHTML = html;
            }

            // Load next sentence
            function loadNextSentence() {
                if (currentSentenceIndex >= 10) return;
                currentSentenceObj = fixedSentences[currentSentenceIndex];
                currentTestNum.innerText = currentSentenceIndex+1;
                nextSentenceBtn.disabled = true; // disable until user records and we finish
                repeatBtn.disabled = false;
                // Speak the sentence and capture AI features
                speakAndCaptureAI(currentSentenceObj.text);
                // Enable record button for user
                recordBtn.disabled = false;
                stopBtn.disabled = true;
            }

            // Recording start
            async function startRecording() {
                try {
                    if (!audioContext) { audioContext = new (window.AudioContext||window.webkitAudioContext)(); analyser = audioContext.createAnalyser(); analyser.fftSize=256; }
                    mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    const source = audioContext.createMediaStreamSource(mediaStream);
                    source.connect(analyser);
                    isRecording = true;
                    isCapturingForUser = true;
                    recordBtn.textContent = 'üî¥ Recording';
                    recordBtn.classList.add('active');
                    stopBtn.disabled = false;
                    waveformStatus.textContent = 'üî¥ Recording...';
                    analyzeAudio();  // start animation
                    if ('webkitSpeechRecognition' in window) {
                        recognition = new webkitSpeechRecognition();
                        recognition.continuous = true;
                        recognition.interimResults = true;
                        recognition.lang = 'en-US';
                        recognition.onresult = (e) => {
                            let transcript = Array.from(e.results).map(r=>r[0].transcript).join('');
                            // optional: show
                        };
                        recognition.start();
                    }
                } catch (e) { alert('Microphone error'); }
            }

            function stopRecording() {
                if (mediaStream) mediaStream.getTracks().forEach(t=>t.stop());
                if (recognition) recognition.stop();
                if (animationFrame) cancelAnimationFrame(animationFrame);
                isRecording = false;
                recordBtn.textContent = 'üé§ Record';
                recordBtn.classList.remove('active');
                stopBtn.disabled = true;
                waveformStatus.textContent = 'Stopped';
                if (isCapturingForUser) {
                    // capture final features (averaged, but we take last known)
                    let feats = captureUserFeatures();
                    userFeatures = feats;
                    updateComparisonBars(userFeatures);
                    finishCurrentSentence();
                }
                resetGraphs();
            }

            function analyzeAudio() {
                if (!isRecording || !analyser) return;
                const dataArray = new Uint8Array(analyser.frequencyBinCount);
                const timeData = new Uint8Array(analyser.frequencyBinCount);
                analyser.getByteFrequencyData(dataArray);
                analyser.getByteTimeDomainData(timeData);
                // Update live stats
                let rms = Math.sqrt(dataArray.reduce((a,b)=>a+b*b,0)/dataArray.length);
                rmsValue.textContent = (rms/2.55).toFixed(1);
                let zc=0; for (let i=1;i<timeData.length;i++) if((timeData[i-1]<128 && timeData[i]>=128)||(timeData[i-1]>=128 && timeData[i]<128)) zc++;
                let zcrVal = Math.round(zc * (audioContext.sampleRate/1000) / timeData.length);
                zcrValue.textContent = zcrVal;
                let weighted=0,sum=0; for (let i=0;i<dataArray.length;i++) { weighted+=i*dataArray[i]; sum+=dataArray[i]; }
                let centroid = sum>0? weighted/sum:0;
                centroidValue.textContent = Math.round(centroid*10);
                // waveform
                let waveBars = document.querySelectorAll('.wave-bar');
                for (let i=0;i<waveBars.length;i++) {
                    let idx = Math.floor(i * (timeData.length/waveBars.length));
                    let val = (timeData[idx]-128)/128;
                    waveBars[i].style.height = Math.abs(val)*50+5+'px';
                }
                if (isCapturingForUser) {
                    // continuously update user features for comparison? we can store latest
                    userFeatures = { rms: rms/2.55, zcr: zcrVal, centroid: Math.round(centroid*10) };
                    updateComparisonBars(userFeatures);
                }
                animationFrame = requestAnimationFrame(analyzeAudio);
            }

            function resetGraphs() {
                document.querySelectorAll('.wave-bar').forEach(b=>b.style.height='2px');
            }

            function addAIMessage(msg) {
                let d=document.createElement('div'); d.className='message ai'; d.textContent='ü§ñ '+msg; chatMessages.appendChild(d); chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            function addUserMessage(msg) {
                let d=document.createElement('div'); d.className='message user'; d.textContent='üë§ '+msg; chatMessages.appendChild(d); chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            function endSession() {
                isSessionActive = false; startSessionBtn.disabled = false; recordBtn.disabled = true; stopBtn.disabled = true; repeatBtn.disabled = true; nextSentenceBtn.disabled = true; stopRecording();
                if (sessionTimer) clearInterval(sessionTimer);
            }
            function resetSession() {
                currentSentenceIndex = 0; results = []; totalAccuracySum = 0; seconds = 0; sessionTimeSpan.textContent='00:00'; sentencesCompletedSpan.textContent='0'; overallAccuracy.textContent='0'; overallProgress.style.width='0%'; runningAvg.innerText='0'; finalAverage.innerText='‚Äî'; updateChecklist();
            }

            // Event listeners
            loginButton.addEventListener('click', ()=>{
                if (document.getElementById('username').value === 'dipu' && document.getElementById('password').value === '1234') {
                    loginContainer.style.display = 'none'; dashboard.classList.add('active'); patientNameSpan.innerText = 'dipu';
                    chatMessages.innerHTML = '<div class="message ai">Hello! I\'ll guide you through 10 specific sentences. Press "Start Assessment" to begin.</div>';
                    resetSession();
                    if (!patientInfo.name) setTimeout(()=>{ /* simulate name capture? skip for brevity, just show start */ }, 500);
                } else alert('Invalid');
            });
            logoutBtn.addEventListener('click', ()=>{ stopRecording(); dashboard.classList.remove('active'); loginContainer.style.display = 'block'; resetSession(); });

            startSessionBtn.addEventListener('click', async ()=>{
                if (!isSessionActive) {
                    isSessionActive = true; startSessionBtn.disabled = true; currentSentenceIndex = 0; results = []; totalAccuracySum=0; updateChecklist();
                    seconds = 0; if(sessionTimer)clearInterval(sessionTimer); sessionTimer = setInterval(()=>{ seconds++; let m=Math.floor(seconds/60), s=seconds%60; sessionTimeSpan.textContent = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`; },1000);
                    await initializeAudio(); loadNextSentence();
                }
            });
            async function initializeAudio() { if (!audioContext) { audioContext = new (window.AudioContext||window.webkitAudioContext)(); analyser = audioContext.createAnalyser(); analyser.fftSize=256; } }

            recordBtn.addEventListener('click', startRecording);
            stopBtn.addEventListener('click', stopRecording);
            repeatBtn.addEventListener('click', ()=>{ if(currentSentenceObj) speakAndCaptureAI(currentSentenceObj.text); });
            nextSentenceBtn.addEventListener('click', ()=>{
                if (currentSentenceIndex < 9) {
                    currentSentenceIndex++;
                    loadNextSentence();
                } else if (currentSentenceIndex === 9) { /* already at last, maybe just finish? */ }
            });

            // Voice stuff
            if (synthesis.onvoiceschanged !== undefined) synthesis.onvoiceschanged = loadVoices;
            voiceSelect.addEventListener('change', function(){ let n=this.value; selectedVoice = availableVoices.find(v=>v.name===n); });
            voiceSpeedInput.addEventListener('input', function(){ voiceSpeed = parseFloat(this.value); speedValue.textContent = `Speed: ${voiceSpeed.toFixed(1)}x`; });
            setTimeout(()=>{ if(availableVoices.length===0) loadVoices(); initGraphs(); }, 500);
        })();
    </script>
</body>
</html>
