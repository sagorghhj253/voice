<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VoiceTherapy ¬∑ Accuracy vs Sentences Graph</title>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #eef2f5;
            padding: 20px;
        }
        .container {
            max-width: 1300px;
            margin: 0 auto;
            background: white;
            border-radius: 36px;
            padding: 30px 35px 40px;
            box-shadow: 0 20px 40px rgba(0,15,40,0.15);
            border: 1px solid #c9d9ec;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 18px;
            border-bottom: 2px solid #dde5f0;
            flex-wrap: wrap;
        }
        .logout {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 60px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            box-shadow: 0 5px 0 #a13f30;
            transition: 0.1s;
        }
        .logout:active { transform: translateY(4px); box-shadow: 0 1px 0 #a13f30; }
        .greeting {
            background: #e1edff;
            display: inline-block;
            padding: 12px 40px;
            border-radius: 60px;
            font-weight: 600;
            color: #113355;
            margin: 20px 0 25px;
            font-size: 1.3rem;
        }
        .main-panel {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
        }
        .left, .right {
            flex: 1 1 380px;
            background: #f7faff;
            border-radius: 40px;
            padding: 26px;
            border: 1px solid #c0d2e8;
            box-shadow: inset 0 2px 6px #ffffff, 0 12px 20px rgba(0,20,50,0.08);
        }
        .sentence-box {
            background: #ffffff;
            border: 3px dashed #1f6392;
            border-radius: 60px;
            padding: 1.6rem;
            font-size: 1.7rem;
            font-weight: 600;
            text-align: center;
            color: #03223f;
            margin-bottom: 25px;
            box-shadow: 0 6px 0 #aac3dc;
            line-height: 1.3;
        }
        .focus-badge {
            background: #0d324d;
            color: white;
            padding: 0.5rem 2.2rem;
            border-radius: 60px;
            display: inline-block;
            margin-bottom: 12px;
            font-weight: 500;
            letter-spacing: 0.3px;
        }
        .ref-audio-row {
            display: flex;
            align-items: center;
            gap: 12px;
            background: #eaf1fc;
            border-radius: 60px;
            padding: 0.5rem 1.5rem 0.5rem 1rem;
            margin: 15px 0 25px;
            flex-wrap: wrap;
        }
        .ref-audio-row audio { height: 40px; width: 240px; }
        .ref-label {
            background: #1b3f62; color: white; padding: 0.3rem 1.4rem; border-radius: 40px;
            font-size: 0.85rem;
        }
        .controls {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin: 20px 0 10px;
        }
        button {
            padding: 16px 30px;
            border: none;
            border-radius: 60px;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            box-shadow: 0 7px 0 rgba(0,0,0,0.1);
            transition: 0.05s;
            background: #cbd9ee;
        }
        button:active { transform: translateY(5px); box-shadow: 0 2px 0 rgba(0,0,0,0.1); }
        button:disabled {
            opacity: 0.5;
            transform: translateY(0);
            box-shadow: 0 4px 0 rgba(0,0,0,0.1);
            cursor: not-allowed;
        }
        .play-ref { background: #2ecc71; color: white; }
        .record-btn { background: #f39c12; color: white; }
        .stop-btn { background: #e67e22; color: white; }
        .next-btn { background: #3498db; color: white; }

        .accuracy-big {
            background: #0b2540; color: white; border-radius: 100px; padding: 1.2rem 2rem;
            text-align: center; font-size: 3rem; font-weight: 700; border: 3px solid #5282b7;
            margin-bottom: 25px;
        }
        .chart-wrap {
            background: white; border-radius: 40px; padding: 20px; border: 1px solid #bed6f0;
            margin-top: 15px;
            min-height: 280px;
            position: relative;
        }
        canvas { max-height: 220px; width: 100% !important; }
        .stat-row {
            display: flex; justify-content: space-between; margin: 20px 0 10px;
            background: #e2edff; padding: 12px 25px; border-radius: 50px;
        }
        .recording-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            background: #ff4444;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
            100% { opacity: 1; transform: scale(1); }
        }

        .progress-circles {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            align-items: center;
            justify-content: center;
            background: #deecfb;
            padding: 20px 30px;
            border-radius: 70px;
            margin: 30px 0 25px;
        }
        
        .progress-label {
            font-weight: 600;
            color: #113355;
            margin-right: 10px;
            font-size: 1.1rem;
        }
        
        .circle {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: #c2d5ed;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.2rem;
            border: 3px solid #7f9fc9;
            transition: all 0.3s ease;
            color: #113355;
        }
        
        .circle.completed {
            background: #2ecc71;
            color: white;
            border-color: #1a763f;
            box-shadow: 0 0 15px rgba(46, 204, 113, 0.5);
        }

        .final-accuracy-box {
            background: linear-gradient(145deg, #f0f7ff, #ffffff); font-size: 2.2rem;
            padding: 1.5rem; border-radius: 90px; text-align: center; border: 2px solid #7ea3cc;
        }
        .status-msg {
            margin-top: 15px;
            padding: 10px;
            border-radius: 30px;
            background: #fff3cd;
            color: #856404;
            text-align: center;
            font-weight: 500;
        }
        .feature-comparison {
            font-size: 0.9rem;
            background: #d4e2fc;
            padding: 8px 15px;
            border-radius: 30px;
            margin-top: 10px;
        }
        .chart-title {
            text-align: center;
            font-weight: 600;
            color: #113355;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
<div class="container">

    <div class="header">
        <h1 style="margin:0;">üó£Ô∏è VoiceTherapy ¬∑ Accuracy Tracking</h1>
        <button class="logout" id="logoutBtn">Logout</button>
    </div>
    <div class="greeting" id="greetingMsg">üëã Hello Dina, ready to start?</div>

    <div class="main-panel">
        <!-- LEFT panel -->
        <div class="left">
            <span class="focus-badge" id="focusTag">ALLITERATION</span>
            <div class="sentence-box" id="sentenceDisplay">
                The quick brown fox jumps over the lazy dog
            </div>

            <div class="ref-audio-row">
                <span class="ref-label">üéµ reference</span>
                <audio id="refAudioPlayer" controls preload="auto">
                    <source src="" type="audio/mpeg">
                </audio>
                <span class="file-hint" id="refFileName">voice1.mp3</span>
            </div>

            <div class="controls">
                <button class="play-ref" id="playRefBtn">üîä play reference</button>
                <button class="record-btn" id="recordBtn">üé§ start recording</button>
                <button class="stop-btn" id="stopBtn" disabled>‚èπ stop</button>
                <button class="next-btn" id="nextBtn" disabled>next ‚Üí</button>
            </div>
            
            <div id="statusMessage" class="status-msg">
                Click "start recording" and speak the sentence
            </div>
            
            <div class="feature-comparison" id="featureDisplay">
                <span id="refFeatures">Reference: RMS:-- ZCR:-- Cent:--</span><br>
                <span id="userFeatures">Your voice: RMS:-- ZCR:-- Cent:--</span>
            </div>
        </div>

        <!-- RIGHT panel with ACCURACY VS SENTENCE graph -->
        <div class="right">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3 style="color:#163856;">üìä current accuracy</h3>
                <span id="accuracyPercent" style="font-weight:700; background:#113355; color:white; padding:6px 24px; border-radius:60px;">0%</span>
            </div>
            <div class="accuracy-big" id="accuracyBigDisplay">0%</div>

            <div class="chart-wrap">
                <div class="chart-title">Accuracy vs Sentence Number</div>
                <canvas id="accuracyChart"></canvas>
                <p style="text-align:center; margin:5px 0 0; color:#666; font-size:0.8rem;">
                    ‚ö° each red dot shows your accuracy for that sentence
                </p>
            </div>
            
            <div class="stat-row">
                <span>üéõ RMS: <span id="rmsVal">0</span></span>
                <span>üìâ ZCR: <span id="zcrVal">0</span></span>
                <span>üìå Centroid: <span id="centVal">0</span></span>
            </div>
        </div>
    </div>

    <!-- PROGRESS CIRCLES - turn green after each sentence -->
    <div class="progress-circles">
        <span class="progress-label">sentences:</span>
        <div class="circle" id="circ1">1</div>
        <div class="circle" id="circ2">2</div>
        <div class="circle" id="circ3">3</div>
        <div class="circle" id="circ4">4</div>
        <div class="circle" id="circ5">5</div>
        <div class="circle" id="circ6">6</div>
        <div class="circle" id="circ7">7</div>
        <div class="circle" id="circ8">8</div>
        <div class="circle" id="circ9">9</div>
        <div class="circle" id="circ10">10</div>
    </div>

    <div class="final-accuracy-box">
        üèÜ final average: <span id="finalAvgValue">0%</span>
    </div>
</div>

<script>
(function() {
    // ----- 10 sentences -----
    const sentences = [
        { text: "The quick brown fox jumps over the lazy dog", focus: "ALLITERATION" },
        { text: "She sells seashells by the seashore", focus: "TONGUE TWISTER" },
        { text: "Peter Piper picked a peck of pickled peppers", focus: "ARTICULATION" },
        { text: "How much wood would a woodchuck chuck", focus: "FLUENCY" },
        { text: "I saw Susie sitting in a shoeshine shop", focus: "CONSONANTS" },
        { text: "Fuzzy Wuzzy was a bear", focus: "VOWELS" },
        { text: "Around the rugged rocks the ragged rascal ran", focus: "RHYTHM" },
        { text: "Six slippery snails slid slowly seaward", focus: "S-BLENDS" },
        { text: "Three free throws", focus: "TH SOUNDS" },
        { text: "Red lorry, yellow lorry", focus: "L/R SOUNDS" }
    ];

    // Get all circle elements
    const circles = [
        document.getElementById('circ1'),
        document.getElementById('circ2'),
        document.getElementById('circ3'),
        document.getElementById('circ4'),
        document.getElementById('circ5'),
        document.getElementById('circ6'),
        document.getElementById('circ7'),
        document.getElementById('circ8'),
        document.getElementById('circ9'),
        document.getElementById('circ10')
    ];

    // State
    let currentIdx = 0;
    let completedSentences = new Array(10).fill(false);
    let accuracies = new Array(10).fill(null);
    
    // Recording state
    let mediaRecorder = null;
    let audioChunks = [];
    let audioContext = null;
    let analyser = null;
    let mediaStream = null;
    let isRecording = false;
    let recordedFeatures = null;
    
    // DOM elements
    const sentenceDisplay = document.getElementById('sentenceDisplay');
    const focusTag = document.getElementById('focusTag');
    const refAudioPlayer = document.getElementById('refAudioPlayer');
    const refFileName = document.getElementById('refFileName');
    const playRefBtn = document.getElementById('playRefBtn');
    const recordBtn = document.getElementById('recordBtn');
    const stopBtn = document.getElementById('stopBtn');
    const nextBtn = document.getElementById('nextBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const accuracyPercent = document.getElementById('accuracyPercent');
    const accuracyBig = document.getElementById('accuracyBigDisplay');
    const finalAvgSpan = document.getElementById('finalAvgValue');
    const rmsVal = document.getElementById('rmsVal');
    const zcrVal = document.getElementById('zcrVal');
    const centVal = document.getElementById('centVal');
    const statusMsg = document.getElementById('statusMessage');
    const refFeatures = document.getElementById('refFeatures');
    const userFeatures = document.getElementById('userFeatures');

    // Pre-define reference features for each sentence
    let referenceFeatures = [];
    for (let i = 0; i < 10; i++) {
        let baseRMS = 40 + (i * 2);
        let baseZCR = 100 + (i * 5);
        let baseCent = 500 + (i * 30);
        
        if (sentences[i].focus === 'S-BLENDS') baseZCR += 30;
        if (sentences[i].focus === 'TH SOUNDS') baseCent += 50;
        if (sentences[i].focus === 'VOWELS') baseRMS += 15;
        
        referenceFeatures[i] = {
            rms: baseRMS,
            zcr: baseZCR,
            centroid: baseCent
        };
    }

    // Initialize ACCURACY VS SENTENCE chart (not frequency)
    const ctx = document.getElementById('accuracyChart').getContext('2d');
    const accuracyChart = new Chart(ctx, {
        type: 'scatter',
        data: {
            datasets: [{
                label: 'Accuracy %',
                data: [],  // empty initially
                backgroundColor: '#be0f0f',
                pointRadius: 8,
                pointStyle: 'circle',
                showLine: false
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    type: 'linear',
                    position: 'bottom',
                    min: 0.5,
                    max: 10.5,
                    title: {
                        display: true,
                        text: 'Sentence Number'
                    },
                    ticks: {
                        stepSize: 1,
                        callback: function(value) {
                            return '#' + value;
                        }
                    }
                },
                y: {
                    min: 0,
                    max: 100,
                    title: {
                        display: true,
                        text: 'Accuracy (%)'
                    },
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `Sentence ${context.parsed.x}: ${context.parsed.y}%`;
                        }
                    }
                },
                legend: {
                    display: false
                }
            }
        }
    });

    // Initialize audio context
    async function initAudio() {
        if (!audioContext) {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            analyser.fftSize = 2048;
        }
    }

    // Start recording
    async function startRecording() {
        try {
            await initAudio();
            
            mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            const source = audioContext.createMediaStreamSource(mediaStream);
            source.connect(analyser);
            
            mediaRecorder = new MediaRecorder(mediaStream);
            audioChunks = [];
            
            mediaRecorder.ondataavailable = event => {
                audioChunks.push(event.data);
            };
            
            mediaRecorder.start();
            isRecording = true;
            
            recordBtn.disabled = true;
            stopBtn.disabled = false;
            nextBtn.disabled = true;
            statusMsg.innerHTML = 'üî¥ Recording... speak the sentence. Click STOP when done.';
            
        } catch (err) {
            statusMsg.innerHTML = 'Error accessing microphone: ' + err.message;
        }
    }

    // Extract features from audio data
    async function extractFeaturesFromAudio(audioBlob) {
        if (!analyser) return null;
        
        const dataArray = new Uint8Array(analyser.frequencyBinCount);
        analyser.getByteFrequencyData(dataArray);
        
        let sum = 0;
        for (let i = 0; i < dataArray.length; i++) {
            sum += dataArray[i] * dataArray[i];
        }
        let rms = Math.sqrt(sum / dataArray.length) / 2.55;
        
        const timeData = new Uint8Array(analyser.frequencyBinCount);
        analyser.getByteTimeDomainData(timeData);
        let zeroCrossings = 0;
        for (let i = 1; i < timeData.length; i++) {
            if ((timeData[i-1] < 128 && timeData[i] >= 128) || 
                (timeData[i-1] >= 128 && timeData[i] < 128)) {
                zeroCrossings++;
            }
        }
        let zcr = (zeroCrossings * 48000) / (timeData.length * 2);
        
        let weightedSum = 0;
        let amplitudeSum = 0;
        for (let i = 0; i < dataArray.length; i++) {
            weightedSum += i * dataArray[i];
            amplitudeSum += dataArray[i];
        }
        let centroid = amplitudeSum > 0 ? (weightedSum / amplitudeSum) * (24000 / dataArray.length) : 0;
        
        return {
            rms: Math.min(100, Math.max(20, rms)),
            zcr: Math.min(500, Math.max(50, zcr)),
            centroid: Math.min(2000, Math.max(200, centroid))
        };
    }

    // Stop recording and analyze
    async function stopRecording() {
        if (mediaRecorder && isRecording) {
            mediaRecorder.stop();
            mediaStream.getTracks().forEach(track => track.stop());
            isRecording = false;
            
            statusMsg.innerHTML = '‚è≥ Processing your voice... analyzing features';
            
            await new Promise(resolve => {
                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    
                    recordedFeatures = await extractFeaturesFromAudio(audioBlob);
                    
                    if (recordedFeatures) {
                        rmsVal.innerText = Math.round(recordedFeatures.rms);
                        zcrVal.innerText = Math.round(recordedFeatures.zcr);
                        centVal.innerText = Math.round(recordedFeatures.centroid);
                        
                        userFeatures.innerHTML = `Your voice: RMS:${Math.round(recordedFeatures.rms)} ZCR:${Math.round(recordedFeatures.zcr)} Cent:${Math.round(recordedFeatures.centroid)}`;
                        
                        compareWithReference(recordedFeatures);
                    }
                    
                    resolve();
                };
            });
            
            recordBtn.disabled = false;
            stopBtn.disabled = true;
        }
    }

    // Compare user features with reference and calculate accuracy
    function compareWithReference(userFeat) {
        let ref = referenceFeatures[currentIdx];
        
        refFeatures.innerHTML = `Reference: RMS:${Math.round(ref.rms)} ZCR:${Math.round(ref.zcr)} Cent:${Math.round(ref.centroid)}`;
        
        let rmsAcc = 100 - (Math.abs(ref.rms - userFeat.rms) / ref.rms * 100);
        let zcrAcc = 100 - (Math.abs(ref.zcr - userFeat.zcr) / ref.zcr * 100);
        let centAcc = 100 - (Math.abs(ref.centroid - userFeat.centroid) / ref.centroid * 100);
        
        let accuracy = Math.round(
            Math.max(0, rmsAcc) * 0.4 + 
            Math.max(0, zcrAcc) * 0.3 + 
            Math.max(0, centAcc) * 0.3
        );
        
        accuracy = Math.min(100, Math.max(0, accuracy));
        
        accuracyPercent.innerText = accuracy + '%';
        accuracyBig.innerText = accuracy + '%';
        
        completeSentence(currentIdx, accuracy);
        
        statusMsg.innerHTML = `‚úÖ Analysis complete! Accuracy: ${accuracy}%`;
    }

    // Mark sentence as completed, turn circle green, and ADD POINT TO GRAPH
    function completeSentence(index, accuracy) {
        if (!completedSentences[index]) {
            completedSentences[index] = true;
            accuracies[index] = accuracy;
            
            // TURN THE CIRCLE GREEN
            circles[index].classList.add('completed');
            
            // ADD ACCURACY POINT TO GRAPH (sentence number vs accuracy)
            let points = [];
            for (let i = 0; i < 10; i++) {
                if (accuracies[i] !== null) {
                    points.push({
                        x: i + 1,  // sentence number (1-based)
                        y: accuracies[i]
                    });
                }
            }
            
            accuracyChart.data.datasets[0].data = points;
            accuracyChart.update();
            
            // Update final average
            let sum = accuracies.filter(a => a !== null).reduce((a,b) => a+b, 0);
            let count = accuracies.filter(a => a !== null).length;
            let avg = count > 0 ? Math.round(sum / count) : 0;
            finalAvgSpan.innerText = avg + '%';
            
            // Enable next button
            nextBtn.disabled = false;
        }
    }

    // Load sentence function
    function loadSentence(index) {
        let s = sentences[index];
        sentenceDisplay.innerText = s.text;
        focusTag.innerText = s.focus;
        
        let fileNum = index + 1;
        let fileName = `voice${fileNum}.mp3`;
        refFileName.innerText = fileName;
        let source = refAudioPlayer.querySelector('source');
        source.src = fileName;
        refAudioPlayer.load();
        
        if (!completedSentences[index]) {
            accuracyPercent.innerText = '0%';
            accuracyBig.innerText = '0%';
            rmsVal.innerText = '0';
            zcrVal.innerText = '0';
            centVal.innerText = '0';
            nextBtn.disabled = true;
            statusMsg.innerHTML = 'Click "start recording" and speak the sentence';
            
            let ref = referenceFeatures[index];
            refFeatures.innerHTML = `Reference: RMS:${Math.round(ref.rms)} ZCR:${Math.round(ref.zcr)} Cent:${Math.round(ref.centroid)}`;
            userFeatures.innerHTML = `Your voice: RMS:-- ZCR:-- Cent:--`;
        }
    }

    // Event listeners
    recordBtn.addEventListener('click', startRecording);
    
    stopBtn.addEventListener('click', stopRecording);
    
    playRefBtn.addEventListener('click', () => {
        refAudioPlayer.play().catch(e => {
            statusMsg.innerHTML = 'Audio file not found. Please add voice1.mp3 - voice10.mp3 files.';
        });
    });

    nextBtn.addEventListener('click', () => {
        if (currentIdx < 9) {
            currentIdx++;
            loadSentence(currentIdx);
        } else {
            statusMsg.innerHTML = 'üéâ Congratulations! You completed all 10 sentences!';
        }
    });

    logoutBtn.addEventListener('click', () => {
        if (isRecording) {
            mediaStream?.getTracks().forEach(track => track.stop());
        }
        alert('Logged out');
    });

    // Load first sentence
    loadSentence(0);
    
    // Initially, ensure no circles are green
    circles.forEach(circle => {
        circle.classList.remove('completed');
    });
    
    // Clear any existing graph data
    accuracyChart.data.datasets[0].data = [];
    accuracyChart.update();
    
})();
</script>
</body>
</html>
